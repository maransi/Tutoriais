<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulário de Investidores</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Toastr CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery Mask -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<!-- jQuery Mask Money -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-maskmoney/3.0.2/jquery.maskMoney.min.js"></script>

<!-- jQuery Validate -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>

<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    label { font-weight: bold; }
    .action-btns button { margin-right: 5px; }
    .form-search-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
    .form-search-group > div { display: flex; flex-direction: column; }
    .form-search-group .btn-group { flex-direction: row; gap: 5px; }
</style>
</head>
<body>
<div class="container my-4">
    <h2>Cadastro e Consulta de Investidores</h2>

    <!-- Caixa do formulário de pesquisa -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="formPesquisa">
                <div class="form-search-group">
                    <div>
                        <label for="cpfInvestidor" class="form-label">CPF do Investidor</label>
                        <input type="text" class="form-control" id="cpfInvestidor" name="cpfInvestidor" placeholder="000.000.000-00">
                    </div>
                    <div>
                        <label for="nomeInvestidor" class="form-label">Nome</label>
                        <input type="text" class="form-control" id="nomeInvestidor" name="nomeInvestidor">
                    </div>
                    <div>
                        <label for="usuarioInvestidor" class="form-label">Usuário</label>
                        <input type="text" class="form-control" id="usuarioInvestidor" name="usuarioInvestidor">
                    </div>
                    <div class="btn-group mt-4">
                        <button type="button" class="btn btn-primary" id="btnPesquisar">Pesquisar</button>
                        <button type="button" class="btn btn-success" id="btnNovo" data-bs-toggle="modal" data-bs-target="#modalInvestidor">Novo</button>
                        <button type="button" class="btn btn-secondary" id="btnLimpar">Limpar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de resultados -->
    <div class="table-responsive">
        <table class="table table-bordered" id="tabelaInvestidores">
            <thead class="table-light">
                <tr>
                    <th>CPF</th>
                    <th>Nome</th>
                    <th>Usuário</th>
                    <th>Total das Carteiras</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dados simulados aparecerão aqui -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para cadastro/edição -->
<div class="modal fade" id="modalInvestidor" tabindex="-1" aria-labelledby="modalInvestidorLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formInvestidor">
        <div class="modal-header">
          <h5 class="modal-title" id="modalInvestidorLabel">Investidor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="modalCpf" class="form-label">CPF</label>
                <input type="text" class="form-control" id="modalCpf" name="modalCpf" required>
            </div>
            <div class="mb-3">
                <label for="modalNome" class="form-label">Nome</label>
                <input type="text" class="form-control" id="modalNome" name="modalNome" required>
            </div>
            <div class="mb-3">
                <label for="modalUsuario" class="form-label">Usuário</label>
                <input type="text" class="form-control" id="modalUsuario" name="modalUsuario" required>
            </div>
            <div class="mb-3">
                <label for="modalTotalCarteiras" class="form-label">Total das Carteiras</label>
                <input type="text" class="form-control" id="modalTotalCarteiras" name="modalTotalCarteiras" required>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalExcluir" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalExcluirLabel">Confirmação de Exclusão</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir este investidor?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="btnConfirmarExcluir">Sim</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
      </div>
    </div>
  </div>
</div>

<script>
// Configuração do Toastr para aparecer no canto inferior direito
toastr.options = {
    "closeButton": true,
    "debug": false,
    "newestOnTop": false,
    "progressBar": true,
    "positionClass": "toast-bottom-right",
    "preventDuplicates": false,
    "onclick": null,
    "showDuration": "300",
    "hideDuration": "1000",
    "timeOut": "3000",
    "extendedTimeOut": "1000",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "fadeIn",
    "hideMethod": "fadeOut"
};

// Função para validar CPF
function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g,'');
    if(cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma = 0, resto;
    for(let i=1;i<=9;i++) soma += parseInt(cpf.substring(i-1,i))*(11-i);
    resto = (soma*10)%11;
    if(resto===10 || resto===11) resto=0;
    if(resto!==parseInt(cpf.substring(9,10))) return false;
    soma = 0;
    for(let i=1;i<=10;i++) soma += parseInt(cpf.substring(i-1,i))*(12-i);
    resto = (soma*10)%11;
    if(resto===10 || resto===11) resto=0;
    if(resto!==parseInt(cpf.substring(10,11))) return false;
    return true;
}

$(document).ready(function(){

    // Máscaras
    $('#cpfInvestidor, #modalCpf').mask('000.000.000-00');
    $('#modalTotalCarteiras').maskMoney({prefix:'R$ ', allowNegative: false, thousands:'.', decimal:',', affixesStay: true});

    // Validação CPF personalizada
    $.validator.addMethod("cpfValido", function(value, element){
        return this.optional(element) || validarCPF(value);
    });

    // Aviso de CPF inválido ao perder o foco
    $('#cpfInvestidor').on('blur', function(){
        let cpf = $(this).val();
        if(cpf && !validarCPF(cpf)){
            toastr.error('CPF inválido!');
        }
    });

    // Limpar campos
    $('#btnLimpar').click(function(){
        $('#formPesquisa')[0].reset();
        $('#tabelaInvestidores tbody').empty(); // Limpa a grade
    });

    // Botão Novo limpa o modal
    $('#btnNovo').click(function(){
        $('#formInvestidor')[0].reset();
    });

    // Validação do formulário do modal
    $('#formInvestidor').validate({
        rules: { modalCpf: { required: true, cpfValido: true } },
        messages: { modalCpf: { cpfValido: "CPF inválido!" } },
        submitHandler: function(form) {
            let investidor = {
                cpf: $('#modalCpf').val(),
                nome: $('#modalNome').val(),
                usuario: $('#modalUsuario').val(),
                total: $('#modalTotalCarteiras').val()
            };
            toastr.success('Investidor salvo com sucesso!');
            $('#modalInvestidor').modal('hide');
            adicionarOuAtualizarTabela(investidor);
        }
    });

    // Função para adicionar ou atualizar a tabela
    function adicionarOuAtualizarTabela(investidor){
        let linha = `<tr data-cpf="${investidor.cpf}">
                        <td>${investidor.cpf}</td>
                        <td>${investidor.nome}</td>
                        <td>${investidor.usuario}</td>
                        <td>${investidor.total}</td>
                        <td class="action-btns">
                            <button class="btn btn-warning btn-sm btnEditar" title="Editar"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger btn-sm btnExcluir" title="Excluir"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
        $('#tabelaInvestidores tbody tr[data-cpf="'+investidor.cpf+'"]').remove();
        $('#tabelaInvestidores tbody').append(linha);
    }

    // Botão pesquisar
    $('#btnPesquisar').click(function(){
        let cpf = $('#cpfInvestidor').val();

        // Limpa a tabela
        $('#tabelaInvestidores tbody').empty();

        // Valida CPF
        if(cpf && !validarCPF(cpf)){
            toastr.error('CPF inválido!');
            return;
        }

        // Dados simulados
        let dadosSimulados = [
            {cpf:'123.456.789-00', nome:'Marco Antonio', usuario:'marco123', total:'R$ 10.000,00'},
            {cpf:'987.654.321-00', nome:'João Silva', usuario:'joaos', total:'R$ 5.000,00'}
        ];
        dadosSimulados.forEach(investidor => adicionarOuAtualizarTabela(investidor));
        toastr.info('Dados simulados carregados!');
    });

    // Edição e exclusão
    $('#tabelaInvestidores').on('click', '.btnEditar', function(){
        let linha = $(this).closest('tr');
        $('#modalCpf').val(linha.find('td:eq(0)').text());
        $('#modalNome').val(linha.find('td:eq(1)').text());
        $('#modalUsuario').val(linha.find('td:eq(2)').text());
        $('#modalTotalCarteiras').val(linha.find('td:eq(3)').text());
        $('#modalInvestidor').modal('show');
    });

    let linhaParaExcluir = null;

    $('#tabelaInvestidores').on('click', '.btnExcluir', function(){
        linhaParaExcluir = $(this).closest('tr');
        $('#modalExcluir').modal('show');
    });

    $('#btnConfirmarExcluir').click(function(){
        if(linhaParaExcluir){
            linhaParaExcluir.remove();
            toastr.warning('Investidor excluído!');
            linhaParaExcluir = null;
            $('#modalExcluir').modal('hide');
        }
    });

});
</script>
</body>
</html>
