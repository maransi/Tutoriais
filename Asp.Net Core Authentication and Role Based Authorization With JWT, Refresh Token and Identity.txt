Asp.Net Core Authentication and Role Based Authorization With JWT, Refresh Token and Identity
---------------------------------------------------------------------------------------------

. Video tutorial

    https://www.youtube.com/watch?v=EnHrfJO0gyE&list=PL7yxJa4Na-ir9DLuPL_8kYhyHJXCoPyaR

. Os fontes do projeto desenvolvido estão na URL abaixo:

    https://github.com/rd003/DotnetApiCompleteAuth

. Enviroment

    . Instalação para as versões acima do Ubuntu 22.04

        wget https://dot.net/v1/dotnet-install.sh
        chmod +x dotnet-install.sh
        ./dotnet-install.sh -c 3.1
        ./dotnet-install.sh -c 5.0
        ./dotnet-install.sh -c 6.0
        ./dotnet-install.sh -c 7.0

        dotnet --version

        # insira as linhas abaixo no arquivo ".bashrc"
        export PATH="home/$USER/.dotnet:/home/$USER/.dotnet/tools:$PATH"
        export DOTNET_ROOT=/home/$USER/.dotnet/

        source ~/.bashrc

        sudo ln -s /home/$USER/.dotnet/dotnet /usr/bin/dotnet

        dotnet --version
        dotnet --list-runtimes
        dotnet --list-sdks

    . Instalação das extensões do VSCode

            C# 
            C# Extensions (JosKreativ)
            C# XML Documentation Comments
            C# Snippets
            Docker
            RapidAPI client      // Rest API

    . Instalação do Nodejs

        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | $SHELL

        echo 'export PATH="/home/$USER/.nvm:$PATH"' >> ~/.bashrc
        echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc 

        nvm --version

        # Para instalar a versão lts mais recente
        nvm install --lts

        # Se quiser instalar uma versão especifica, utilize:
        # nvm install 18.20.4

        # Se quiser listar as versões do node disponivel no repositorio remoto
        # nvm ls-remote

        # Se quiser listar as versões instalada na máquina atual
        # nvm ls

        # Para usar uma versão instalada na máquina atual
        # nvm use 20.17.0

        # Para desinstalar uma versão do node js
        # nvm uninstall 18.20.4

        node -v
        npm -v

    . Instalação do Git

        sudo apt-get install git
        git --version
        git config --global user.name "maransi"
        git config --global user.email "maransi"
        git config --list

    . Instalação do Docker

        # Acesse o paragrafo "Install Docker Desktop" e execute o passo a passo

        # Ubuntu
        https://docs.docker.com/desktop/setup/install/linux/ubuntu/

        # Debian
        https://docs.docker.com/desktop/setup/install/linux/debian/


. Creating a new project


    . Digite os comandos abaixo na pasta de projetos:

        dotnet new sln -o DotnetApiCompleteAuth

        cd DonetApiCompleteAuth

        # dotnet new webapi --use-controllers -n DotnetApiCompleteAuth -o DotnetApiCompleteAuth --no-openapi -f net8.0 
         dotnet new webapi --use-controllers -n DotnetApiCompleteAuth -o ./src/DotnetApiCompleteAuth  -f net8.0

        dotnet sln add ./src/DotnetApiCompleteAuth/DotnetApiCompleteAuth.csproj

        git init

        dotnet new gitignore

    . Acesse a pasta da solution com o VSCode

    . Apague o controller "./Controllers/WeatherForecastController.cs" e a classe "./WeatherForecast.cs"

/*
    . Acesse a classe "Program.cs" e apague as linhas abaixo:

        var builder = WebApplication.CreateBuilder(args);

        builder.services.addControllers();

        builder.Services.AddSwaggerGen();

        // builder.Services.AddOpenApi();       // Linha eliminada

        var app = builder.Build();

        /*                                      // Bloco de código elimanado

        if (app.Enviroment.IsDevelopment())
        {
            app.MapOpenApi();
        }

        */
*/
    . Acesse o prompt do terminal e a pasta raiz da "solution" e execute o comando abaixo:

        dotnet clean

        dotnet build

        git add .

        git commit -am "feat: first commit"

. Creating the PeopleController

    . Podemos criar um controller com o "dotnet cli"

    . Precisamos ter o pacote "Microsoft.VisualStudio.Web.CodeGeneration.Design" instalado no seu projeto para usar esse comando. 
        Se você não tiver esse pacote instalado, você pode instalá-lo usando o comando:

        dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design --version 8.0.7

        dotnet tool install -g dotnet-aspnet-codegenerator --version 9.0.0

    . Sintaxe


        dotnet aspnet-codegenerator controller -name NomeDoController -async -api -m NomeDoModelo -dc NomeDoDbContext -outDir Controllers

        . Este comando cria um novo controller com o nome especificado, com suporte a async/await, API e usando o modelo e contexto de dados especificados.

        . Aqui está uma explicação dos parâmetros:

            -name: especifica o nome do controller.
            -async: especifica que o controller deve ser criado com suporte a async/await.
            -api: especifica que o controller deve ser criado como um controller API.
            -m: especifica o nome do modelo que o controller deve usar.
            -dc: especifica o nome do contexto de dados que o controller deve usar.
            -outDir: especifica o diretório onde o controller deve ser criado.

    . Exemplo

        dotnet aspnet-codegenerator controller -name ProdutosController -async -api -m Produto -dc MeuDbContext -outDir Controllers  

        # dotnet aspnet-codegenerator controller -name PeopleController -async -api -outDir Controllers

    . Crie a classe "PeopleController.cs" dentro da pasta "Controllers" com o conteúdo abaixo, ou execute o comando "dotnet cli" acima:

        using Microsoft.AspNetCore.Http;
        using Microsoft.AspNetCore.Mvc;
        using Microsoft.AspNetCore.Authorization;

        namespace DotnetApiCompleteAuth.Controllers;

        [Route("api/[controller]")]
        [ApiController]
        public class PeopleController : ControllerBase
        {
            [HttpGet]
            [AllowAnonymous]
            public IActionResult GetPeople()
            {
                return Ok("People data");
            }

            [HttpPost]
            public IActionResult CreatePerson()
            {
                return Ok("Person is created");
            }
        }

    . Executando o projeto pela solution:

        dotnet clean

        dotnet restore

        dotnet build

        dotnet run --project DotnetApiCompleteAuth/ 

    . Executando o projeto diretamente pelo projeto:

        cd DotnetApiCompleteAuth

        dotnet clean

        dotnet restore

        dotnet build

        dotnet run

    . Acesse o Postman e execute as APIs com os parâmetros abaixo:

        method: GET
        url: http://localhost:[porta]/api/people

        method: POST
        url: http://localhost:[porta]/api/people


. Using scalar instead of swagger

https://www.youtube.com/watch?v=Tx49o-5tkis&list=PL7yxJa4Na-ir9DLuPL_8kYhyHJXCoPyaR&index=4


// Tentar utilizar a package "Microsoft.AspNetCore.OpenApi"
// Acesse o link "https://guides.scalar.com/scalar/scalar-api-references/net-integration"

    . Acesse o prompt da pasta raiz do projeto de API e execute o comando abaix:

        dotnet add package AspNetCore.Scalar --version 1.1.1   

21.40
    . Acesse o arquivo "Programs.cs" e realize as alterações abaixo:




. Adding required Nuget Packages

    using AspNetCore.Scalar;                        // Linha inserida

    var builder = WebApplication.CreateBuilder(args);
        
    // Add services to the container.
    builder.Services.AddControllers();


    // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
    builder.Services.AddEndpointsApiExplorer();
    builder.Services.AddSwaggerGen();

    var app = builder.Build();

    // Configure the HTTP request pipeline.
    if (app.Environment.IsDevelopment())
    {
        app.UseSwagger();

        app.MapScalarApiReference();            // Linha insrida

        app.UseSwaggerUI();
    }

    // Bloco inserido
    app.UseScalar( options => 
    {
        options.UseTheme(Theme.Default);
        options.RoutePrefix = "api-docs";

    });

    app.UseHttpsRedirection();

    app.UseAuthorization();

    app.MapControllers();

    app.Run();
